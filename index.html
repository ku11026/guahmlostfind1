<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>분실물 게시판 (GitHub Issues 기반)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      font-size: 16px;
    }
    #top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #left-menu {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #left-menu button, #admin-btn {
      padding: 5px 10px;
    }
    #admin-controls {
      display: flex;
      gap: 5px;
      align-items: center;
    }
    #content > div {
      display: none;
      margin-top: 20px;
    }
    .item {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
      position: relative;
      cursor: pointer;
    }
    .item img {
      max-width: 100px;
      margin-top: 5px;
    }
    .delete-btn, .comment-delete-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      display: none;
      background: #f66;
      color: white;
      border: none;
      padding: 3px 6px;
      cursor: pointer;
    }
    .comment-delete-btn {
      position: static;
      margin-left: 5px;
    }
    .admin-mode .delete-btn,
    .admin-mode .comment-delete-btn {
      display: inline-block;
    }
    label {
      display: block;
      margin-top: 10px;
    }
    input[type="text"], input[type="date"], textarea {
      width: 100%;
      padding: 5px;
    }
    #loading {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #ccc;
      padding: 20px;
      font-size: 18px;
      z-index: 1000;
    }
    #fullscreen-img {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.8);
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    #fullscreen-img img {
      max-width: 90%;
      max-height: 90%;
    }
    #fullscreen-close {
      position: absolute;
      top: 20px;
      right: 40px;
      font-size: 30px;
      color: white;
      cursor: pointer;
    }
    img.markdown-image {
      max-width: 100%;
      height: auto;
    }
    pre, p {
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    #timer {
      font-size: 12px;
      color: red;
    }
  </style>
</head>
<body>

<div id="top-bar">
  <div id="left-menu">
    <button onclick="showPage('list')">분실품 보기</button>
    <button onclick="showPage('register')">분실품 등록</button>
    <button onclick="showPage('search')">내물건찾기</button>
  </div>
  <div id="admin-controls">
    <button onclick="adjustFontSize(1)">글자 +</button>
    <button onclick="adjustFontSize(-1)">글자 -</button>
    <button id="admin-btn" onclick="enterAdmin()">관리자</button>
    <span id="timer"></span>
  </div>
</div>

<div id="loading">⏳ 불러오는 중...</div>

<div id="content">
  <div id="list">
    <h2>분실물 목록</h2>
    <div id="itemList"></div>
  </div>

  <div id="register">
    <h2>분실물 등록</h2>
    <label>제목 <input type="text" id="title"></label>
    <label>내용 <textarea id="keyword" rows="4"></textarea></label>
    <label>사진 업로드 <input type="file" id="photoInput" accept="image/*"></label>
    <label>작성자 <input type="text" id="author"></label>
    <label>표시일 <input type="date" id="date"></label>
    <br>
    <button onclick="cancelRegister()">취소</button>
    <button onclick="submitRegister()">등록</button>
  </div>

  <div id="search">
    <h2>내 물건 찾기</h2>
    <input type="text" id="searchInput" placeholder="검색어 입력">
    <button onclick="searchItems()">검색</button>
    <div id="searchResult"></div>
  </div>

  <div id="detail" style="display:none;">
    <button onclick="showPage('list')">← 목록으로</button>
    <h2 id="detail-title"></h2>
    <div id="detail-body"></div>
    <div id="comment-section">
      <h3>댓글</h3>
      <div id="comments"></div>
      <textarea id="commentInput" placeholder="댓글 작성..."></textarea><br>
      <button onclick="submitComment()">등록</button>
    </div>
  </div>
</div>

<div id="fullscreen-img">
  <span id="fullscreen-close" onclick="closeFullscreen()">✖</span>
  <img src="" alt="전체보기">
</div>

<script>
  // ===== GitHub API 설정 (내장 버전) =====
  const REPO_OWNER = "ku11026";
  const REPO_NAME = "guahmlostlist";
  const GITHUB_TOKEN = "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"; // ⚠️ 테스트용 토큰

  const ADMIN_PASSWORD = "guahmlostmanage11026!@#";
  let isAdmin = false;
  let adminTimer = null;

  // ===== 공용 함수 =====
  function showLoading(show) {
    document.getElementById('loading').style.display = show ? 'block' : 'none';
  }

  async function githubRequest(url, method = "GET", body = null) {
    showLoading(true);
    const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/${url}`, {
      method,
      headers: {
        "Authorization": `token ${GITHUB_TOKEN}`,
        "Accept": "application/vnd.github.v3+json",
        "Content-Type": "application/json"
      },
      body: body ? JSON.stringify(body) : null
    });
    showLoading(false);
    return res.json();
  }

  // ===== 페이지 표시 =====
  function showPage(page) {
    document.querySelectorAll('#content > div').forEach(div => div.style.display = 'none');
    document.getElementById(page).style.display = 'block';
    if (page === 'list') renderList();
  }

  function cancelRegister() {
    ['title', 'keyword', 'photoInput', 'author', 'date'].forEach(id => document.getElementById(id).value = '');
    showPage('list');
  }

  async function submitRegister() {
    const title = document.getElementById('title').value;
    const keyword = document.getElementById('keyword').value;
    const author = document.getElementById('author').value;
    const date = document.getElementById('date').value;
    const file = document.getElementById('photoInput').files[0];

    if (!file) return alert("사진을 선택해주세요.");
    const reader = new FileReader();
    reader.onload = async function (e) {
      await githubRequest(`issues`, "POST", {
        title: title,
        body: `**내용:** ${keyword}\n\n**작성자:** ${author}\n\n**표시일:** ${date}\n\n![사진](${e.target.result})`
      });
      alert("등록 완료!");
      showPage('list');
    };
    reader.readAsDataURL(file);
  }

  async function renderList() {
    const issues = await githubRequest("issues?state=open");
    const container = document.getElementById('itemList');
    container.innerHTML = '';
    if (issues.length === 0) {
      container.innerHTML = '<p>등록된 분실물이 없습니다.</p>';
      return;
    }
    issues.forEach(issue => {
      const div = document.createElement('div');
      div.className = 'item' + (isAdmin ? ' admin-mode' : '');
      div.innerHTML = `
        <strong>${issue.title}</strong><br>
        <span>${issue.body.substring(0, 100)}...</span>
        <button class="delete-btn" onclick="deleteItem(${issue.number}); event.stopPropagation();">삭제</button>
      `;
      div.onclick = () => showDetail(issue.number);
      container.appendChild(div);
    });
  }

  async function showDetail(num) {
    const issue = await githubRequest(`issues/${num}`);
    const comments = await githubRequest(`issues/${num}/comments`);
    document.getElementById('detail-title').innerText = issue.title;
    document.getElementById('detail-body').innerHTML = issue.body
      .replace(/!\[.*?\]\((.*?)\)/g, `<img src="$1" class="markdown-image" onclick="openFullscreen('$1')">`)
      .replace(/\n/g, "<br>");
    const cDiv = document.getElementById('comments');
    cDiv.innerHTML = '';
    comments.forEach(c => {
      const el = document.createElement('div');
      el.innerHTML = `<b>${c.user.login}</b>: ${c.body}
        ${isAdmin ? `<button class='comment-delete-btn' onclick='deleteComment(${num}, ${c.id})'>삭제</button>` : ''}`;
      cDiv.appendChild(el);
    });
    document.getElementById('detail').style.display = 'block';
    document.getElementById('list').style.display = 'none';
    window.currentIssue = num;
  }

  async function submitComment() {
    const text = document.getElementById('commentInput').value;
    if (!text.trim()) return;
    await githubRequest(`issues/${window.currentIssue}/comments`, "POST", { body: text });
    document.getElementById('commentInput').value = '';
    showDetail(window.currentIssue);
  }

  async function deleteItem(num) {
    if (!isAdmin) return;
    if (confirm("정말 삭제하시겠습니까?")) {
      await githubRequest(`issues/${num}`, "PATCH", { state: "closed" });
      renderList();
    }
  }

  async function deleteComment(issueNum, commentId) {
    if (!isAdmin) return;
    if (confirm("댓글을 삭제하시겠습니까?")) {
      await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/comments/${commentId}`, {
        method: "DELETE",
        headers: { "Authorization": `token ${GITHUB_TOKEN}` }
      });
      showDetail(issueNum);
    }
  }

  function openFullscreen(src) {
    document.querySelector('#fullscreen-img img').src = src;
    document.getElementById('fullscreen-img').style.display = 'flex';
  }

  function closeFullscreen() {
    document.getElementById('fullscreen-img').style.display = 'none';
  }

  function adjustFontSize(delta) {
    const body = document.body;
    const currentSize = parseFloat(window.getComputedStyle(body).fontSize);
    body.style.fontSize = (currentSize + delta) + "px";
  }

  function enterAdmin() {
    const pw = prompt("관리자 비밀번호를 입력하세요:");
    if (pw === ADMIN_PASSWORD) {
      isAdmin = true;
      alert("관리자 모드 활성화 (2분)");
      startAdminTimer();
      renderList();
    } else {
      alert("비밀번호가 틀렸습니다.");
    }
  }

  function startAdminTimer() {
    clearInterval(adminTimer);
    let remain = 120;
    const timerEl = document.getElementById('timer');
    timerEl.textContent = "관리자 남은시간: 120초";
    adminTimer = setInterval(() => {
      remain--;
      timerEl.textContent = `관리자 남은시간: ${remain}초`;
      if (remain <= 0) {
        clearInterval(adminTimer);
        timerEl.textContent = "";
        isAdmin = false;
        alert("관리자 모드가 자동 종료되었습니다.");
        renderList();
      }
    }, 1000);
  }

  // 초기화
  showPage('list');
</script>

</body>
</html>
